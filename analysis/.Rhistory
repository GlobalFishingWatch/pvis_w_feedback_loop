##set working directory
#setwd("/Users/willarosebrooks/Documents/GitHub_GFW/product-data-qa/vessel-identity/")
# Default packages
rm(list = ls())
library(tidyverse, quietly = T)
library(fishwatchr)
library(lubridate)
library(glue)
# BigQuery connection
con <- DBI::dbConnect(bigrquery::bigquery(),
project = "world-fishing-827",
use_legacy_sql = FALSE)
##set working directory
#setwd("/Users/willarosebrooks/Documents/GitHub_GFW/product-data-qa/vessel-identity/")
# Default packages
rm(list = ls())
library(tidyverse, quietly = T)
library(fishwatchr)
library(lubridate)
library(glue)
# BigQuery connection
con <- DBI::dbConnect(bigrquery::bigquery(),
project = "world-fishing-827",
page_size = 5000,
use_legacy_sql = FALSE)
## load query
query_vid_matching = paste('
SELECT *,
core_n_shipname = vi_shipname AS shipname_match,
core_n_norm_shipname = vi_norm_shipname AS norm_shipname_match,
## add fuzzy matching / are names close udf
## udf currently does not work
--udfs.are_names_close(CAST(core_n_shipname AS string), CAST(vi_shipname AS string), 0.2) AS are_names_close_02,
--udfs.are_names_close(CAST(core_n_shipname AS string), CAST(vi_shipname AS string), 0.3) AS are_names_close_03,
core_n_callsign = vi_callsign AS callsign_match,
core_n_callsign = vi_norm_callsign AS norm_callsign_match,
core_imo = vi_imo AS imo_match,
--cast(core_imo as string) = cast(vi_norm_imo as string) AS norm_imo_match,
vi_shipname IS NULL as vi_shipname_null,
(TIMESTAMP_DIFF(vi_last_timestamp, vi_first_timestamp, second)/3600) as vi_identity_duration_hr,
FROM
`world-fishing-827.scratch_willa_ttl100.vessel_record_vessel_id_matching_2022dec16`
')
## run encounters query
vid_matching <-
fishwatchr::gfw_query(
query = query_vid_matching,
run_query = TRUE,
con = con
)$data
View(vid_matching)
##set working directory
#setwd("/Users/willarosebrooks/Documents/GitHub_GFW/product-data-qa/vessel-identity/")
# Default packages
rm(list = ls())
library(tidyverse, quietly = T)
library(fishwatchr)
library(lubridate)
library(glue)
# BigQuery connection
con <- DBI::dbConnect(bigrquery::bigquery(),
project = "world-fishing-827",
page_size = 5000,
use_legacy_sql = FALSE)
query_one <- readr::read_file(
file = here::here("queries", "query_1_vid_link.sql")
)
## load query
query_vid_matching = paste('
WITH
## compare shipname, callsign, and imo
results AS (SELECT *,
core_n_shipname = vi_shipname AS shipname_match,
core_n_norm_shipname = vi_norm_shipname AS norm_shipname_match,
## add fuzzy matching / are names close udf
## udf currently does not work
--udfs.are_names_close(CAST(core_n_shipname AS string), CAST(vi_shipname AS string), 0.2) AS are_names_close_02,
--udfs.are_names_close(CAST(core_n_shipname AS string), CAST(vi_shipname AS string), 0.3) AS are_names_close_03,
core_n_callsign = vi_callsign AS callsign_match,
core_n_callsign = vi_norm_callsign AS norm_callsign_match,
core_imo = vi_imo AS imo_match,
--cast(core_imo as string) = cast(vi_norm_imo as string) AS norm_imo_match,
vi_shipname IS NULL as vi_shipname_null,
(TIMESTAMP_DIFF(vi_last_timestamp, vi_first_timestamp, second)/3600) as vi_identity_duration_hr,
FROM
`world-fishing-827.scratch_willa_ttl100.vessel_record_vessel_id_matching_2022dec16`)
## add logic in to define match confidence
## logic to be improve/fixed once are names close udf is fixed
SELECT
*,
CASE WHEN shipname_match THEN "high"
WHEN (NOT shipname_match AND callsign_match) THEN "medium"
ELSE "low"
END as confidence
FROM
results
')
## run encounters query
vid_matching <-
fishwatchr::gfw_query(
query = query_vid_matching,
run_query = TRUE,
con = con
)$data
View(vid_matching)
